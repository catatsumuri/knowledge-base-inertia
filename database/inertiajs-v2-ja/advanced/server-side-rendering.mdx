---
title: サーバーサイドレンダリング（SSR）
---

サーバーサイドレンダリングは、サーバー上で JavaScript ページを事前にレンダリングし、訪問者がアプリケーションにアクセスした際に、完全にレンダリングされた HTML を受け取れるようにします。完全にレンダリングされた HTML がアプリケーションから提供されるため、検索エンジンによるサイトのインデックス化も容易になります。

サーバーサイドレンダリングでは、バックグラウンドプロセスで Node.js を使用してページをレンダリングします。そのため、サーバーサイドレンダリングを正しく動作させるには、サーバー上で Node が利用可能である必要があります。

## Laravel スターターキット

[Laravel スターターキット](https://laravel.com/docs/starter-kits) を使用している場合、Inertia SSR はビルドコマンドを通じて [サポート](https://laravel.com/docs/starter-kits#inertia-ssr) されています。

```bash
npm run build:ssr
```

## 依存関係のインストール

Laravel スターターキットを使用しておらず、SSR を手動で設定したい場合は、まずサーバーサイドレンダリングに必要な追加の依存関係をインストールします。これは Vue アダプターのみで必要となるため、React や Svelte を使用している場合はこの手順をスキップできます。

<CodeGroup>

```bash Vue icon="vuejs"
npm install @vue/server-renderer
```

```js React icon="react"
// 追加の依存関係は不要です
```

```js Svelte icon="s"
// 追加の依存関係は不要です
```

</CodeGroup>

## サーバーエントリーポイントの追加

次に、Laravel プロジェクト内に `resources/js/ssr.js` ファイルを作成し、これを SSR のエントリーポイントとして使用します。

```bash
touch resources/js/ssr.js
```

このファイルは `resources/js/app.js` ファイルと非常によく似ていますが、ブラウザではなく Node.js 上で実行される点が異なります。以下は完全な例です。

<CodeGroup>

```js Vue icon="vuejs"
import { createInertiaApp } from '@inertiajs/vue3'
import createServer from '@inertiajs/vue3/server'
import { renderToString } from '@vue/server-renderer'
import { createSSRApp, h } from 'vue'

createServer(page =>
    createInertiaApp({
        page,
        render: renderToString,
        resolve: name => {
            const pages = import.meta.glob('./Pages/**/*.vue', { eager: true })
            return pages[`./Pages/${name}.vue`]
        },
        setup({ App, props, plugin }) {
            return createSSRApp({
                render: () => h(App, props),
            }).use(plugin)
        },
    }),
)
```

```jsx React icon="react"
import { createInertiaApp } from '@inertiajs/react'
import createServer from '@inertiajs/react/server'
import ReactDOMServer from 'react-dom/server'

createServer(page =>
    createInertiaApp({
        page,
        render: ReactDOMServer.renderToString,
        resolve: name => {
            const pages = import.meta.glob('./Pages/**/*.jsx', { eager: true })
            return pages[`./Pages/${name}.jsx`]
        },
        setup: ({ App, props }) => <App {...props} />,
    }),
)
```

```js Svelte 4 icon="s"
import { createInertiaApp } from '@inertiajs/svelte'
import createServer from '@inertiajs/svelte/server'

createServer(page =>
    createInertiaApp({
        page,
        resolve: name => {
            const pages = import.meta.glob('./Pages/**/*.svelte', { eager: true })
            return pages[`./Pages/${name}.svelte`]
        },
        setup({ App, props }) {
            return App.render(props)
        },
    }),
)
```

```js Svelte 5 icon="s"
import { createInertiaApp } from '@inertiajs/svelte'
import createServer from '@inertiajs/svelte/server'
import { render } from 'svelte/server'

createServer(page =>
    createInertiaApp({
        page,
        resolve: name => {
            const pages = import.meta.glob('./Pages/**/*.svelte', { eager: true })
            return pages[`./Pages/${name}.svelte`]
        },
        setup({ App, props }) {
            return render(App, { props })
        },
    }),
)
```

</CodeGroup>

このファイルを作成する際は、SSR モードで実行するのに適した、`app.js` ファイルに含まれているが不足しているもの（プラグインやカスタムミックスインなど）があれば追加してください。

### クラスタリング

デフォルトでは、SSR サーバーは単一スレッドで実行されます。クラスタリングを有効にすると、同じポート上で複数の Node サーバーが起動され、リクエストはラウンドロビン方式で各スレッドによって処理されます。

`createServer` に第 2 引数としてオプションを渡すことで、クラスタリングを有効にできます。

<CodeGroup>

```js Vue icon="vuejs"
import { createInertiaApp } from '@inertiajs/vue3'
import createServer from '@inertiajs/vue3/server'
import { renderToString } from '@vue/server-renderer'
import { createSSRApp, h } from 'vue'

createServer(page =>
    createInertiaApp({
        // ...
    }),
    { cluster: true },
)
```

```jsx React icon="react"
import { createInertiaApp } from '@inertiajs/react'
import createServer from '@inertiajs/react/server'
import ReactDOMServer from 'react-dom/server'

createServer(page =>
    createInertiaApp({
        // ...
    }),
    { cluster: true },
)
```

```js Svelte 4 icon="s"
import { createInertiaApp } from '@inertiajs/svelte'
import createServer from '@inertiajs/svelte/server'

createServer(page =>
    createInertiaApp({
        // ...
    }),
    { cluster: true },
)
```

```js Svelte 5 icon="s"
import { createInertiaApp } from '@inertiajs/svelte'
import createServer from '@inertiajs/svelte/server'
import { render } from 'svelte/server'

createServer(page =>
    createInertiaApp({
        // ...
    }),
    { cluster: true },
)
```

</CodeGroup>

## Vite のセットアップ

次に、新しく作成した `ssr.js` ファイルをビルドするために、Vite の設定を更新します。`vite.config.js` ファイル内の Laravel の Vite プラグイン設定に `ssr` プロパティを追加します。

```js:vite.config.js
export default defineConfig({
    plugins: [
        laravel({
            input: ['resources/css/app.css', 'resources/js/app.js'],
            ssr: 'resources/js/ssr.js', // [!code ++]
            refresh: true,
        }),
        // ...
    ],
})
```

## NPM スクリプトの更新

次に、`package.json` ファイル内の `build` スクリプトを更新し、新しい `ssr.js` ファイルもビルドされるようにします。

```json:package.json
"scripts": {
    "dev": "vite",
   "build": "vite build" // [!code --]
   "build": "vite build && vite build --ssr" // [!code ++]
},
```

これで、クライアントサイドおよびサーバーサイドの両方のバンドルをビルドできます。

```bash
npm run build
```

## SSR サーバーの実行

クライアントサイドとサーバーサイドの両方のバンドルをビルドしたら、次のコマンドを使用して Node ベースの Inertia SSR サーバーを実行できます。

```bash
php artisan inertia:start-ssr
```

`--runtime` オプションを使用して、利用するランタイムを指定することもできます。これにより、デフォルトの Node.js ランタイムから Bun に切り替えることができます。

```bash
php artisan inertia:start-ssr --runtime=bun
```

サーバーが起動すると、サーバーサイドレンダリングが有効な状態でブラウザからアプリにアクセスできるようになります。実際、JavaScript を完全に無効にしても、アプリケーション内を移動できるはずです。

## クライアントサイドハイドレーション

<ClientSpecific>
ウェブサイトがサーバーサイドレンダリングされるようになったため、<VueSpecific>Vue</VueSpecific><ReactSpecific>React</ReactSpecific><SvelteSpecific>Svelte</SvelteSpecific> に対して、生成されたすべての HTML を再レンダリングする代わりに、静的マークアップを「ハイドレート」してインタラクティブにするよう指示できます。
</ClientSpecific>

<VueSpecific>Vue アプリでクライアントサイドハイドレーションを有効にするには、`ssr.js` ファイルで `createApp` の代わりに `createSSRApp` を使用するよう更新してください。</VueSpecific>

<ReactSpecific>React アプリでクライアントサイドハイドレーションを有効にするには、`ssr.js` ファイルで `createRoot` の代わりに `hydrateRoot` を使用するよう更新してください。</ReactSpecific>

<Svelte4Specific>Svelte 4 アプリでクライアントサイドハイドレーションを有効にするには、`ssr.js` ファイルで `hydrate` オプションを `true` に設定してください。</Svelte4Specific>

<Svelte5Specific>Svelte 5 アプリでクライアントサイドハイドレーションを有効にするには、サーバーレンダリング時に `mount` の代わりに `hydrate` を使用するよう `ssr.js` ファイルを更新してください。</Svelte5Specific>

<CodeGroup>

```js Vue icon="vuejs"
import { createApp, h } from 'vue' // [!code --]
import { createSSRApp, h } from 'vue' // [!code ++]
import { createInertiaApp } from '@inertiajs/vue3'

createInertiaApp({
    resolve: name => {
        const pages = import.meta.glob('./Pages/**/*.vue', { eager: true })
        return pages[`./Pages/${name}.vue`]
    },
    setup({ el, App, props, plugin }) {
    createApp({ render: () => h(App, props) }) // [!code --]
    createSSRApp({ render: () => h(App, props) }) // [!code ++]
        .use(plugin)
        .mount(el)
    },
})
```

```js React icon="react"
import { createInertiaApp } from '@inertiajs/react'
import { createRoot } from 'react-dom/client' // [!code --]
import { hydrateRoot } from 'react-dom/client' // [!code ++]

createInertiaApp({
    resolve: name => {
        const pages = import.meta.glob('./Pages/**/*.jsx', { eager: true })
        return pages[`./Pages/${name}.jsx`]
    },
    setup({ el, App, props }) {
        createRoot(el).render(<App {...props} />) // [!code --]
        hydrateRoot(el, <App {...props} />) // [!code ++]
    },
})
```

```js Svelte 4 icon="s"
import { createInertiaApp } from '@inertiajs/svelte'

createInertiaApp({
    resolve: name => {
        const pages = import.meta.glob('./Pages/**/*.svelte', { eager: true })
        return pages[`./Pages/${name}.svelte`]
    },
    setup({ el, App, props }) {
        new App({ target: el, props }) // [!code --]
        new App({ target: el, props, hydrate: true }) // [!code ++]
    },
})
```

```js Svelte 5 icon="s"
import { createInertiaApp } from '@inertiajs/svelte'
import { mount } from 'svelte' // [!code --]
import { hydrate, mount } from 'svelte' // [!code ++]

createInertiaApp({
    resolve: name => {
        const pages = import.meta.glob('./Pages/**/*.svelte', { eager: true })
        return pages[`./Pages/${name}.svelte`]
    },
    setup({ el, App, props }) {
        mount(App, { target: el, props }) // [!code --]
        if (el.dataset.serverRendered === 'true') { // [!code ++:5]
            hydrate(App, { target: el, props })
        } else {
            mount(App, { target: el, props })
        }
    },
})
```

</CodeGroup>

<Svelte4Specific>

また、`vite.config.js` ファイルで `hydratable` コンパイラオプションを `true` に設定する必要があります。

```js vite.config.js
import { svelte } from '@sveltejs/vite-plugin-svelte'
import laravel from 'laravel-vite-plugin'
import { defineConfig } from 'vite'

export default defineConfig({
    plugins: [
        laravel.default({
            input: ['resources/css/app.css', 'resources/js/app.js'],
            ssr: 'resources/js/ssr.js',
            refresh: true,
        }),
        svelte(), // [!code --]
        svelte({ // [!code ++:5]
            compilerOptions: {
                hydratable: true,
            },
        }),
    ],
})
```
</Svelte4Specific>

## SSR の無効化

場合によっては、アプリケーション内の特定のページやルートでサーバーサイドレンダリングを無効にしたいことがあります。その場合、現在のリクエストに対して `inertia.ssr.enabled` 設定値を `false` に設定します。通常はサービスプロバイダやミドルウェア内で行います。

```php
if (request()->is('admin/*')) {
    config(['inertia.ssr.enabled' => false]);
}
```

## デプロイ

SSR を有効にしたアプリを本番環境にデプロイする際は、クライアントサイド（`app.js`）とサーバーサイド（`ssr.js`）の両方のバンドルをビルドし、その後、Supervisor などのプロセス監視ツールを使用して SSR サーバーをバックグラウンドプロセスとして実行する必要があります。

```bash
php artisan inertia:start-ssr
```

新しいバージョンのウェブサイトをデプロイする際などに SSR サーバーを停止するには、`inertia:stop-ssr` Artisan コマンドを使用できます。プロセスモニター（Supervisor など）が、停止後に SSR サーバーを自動的に再起動する役割を担う必要があります。

```bash
php artisan inertia:stop-ssr
```

`inertia:check-ssr` Artisan コマンドを使用すると、SSR サーバーが稼働していることを確認できます。これはデプロイ後に役立ち、Docker のヘルスチェックとしても、サーバーが期待どおりに応答していることを確認するのに有効です。

```bash
php artisan inertia:check-ssr
```

デフォルトでは、SSR サーバーにリクエストを送信する前に、サーバーサイドバンドルが存在することを確認するチェックが行われます。アプリが複数のサーバーで実行されている場合や、コンテナ化されている場合など、ウェブサーバーが SSR バンドルにアクセスできないケースでは、このチェックを無効にするために `inertia.ssr.ensure_bundle_exists` 設定値を `false` に設定できます。

### Laravel Cloud

Laravel Cloud で SSR サーバーを実行するには、Cloud の [Inertia SSR ネイティブサポート](https://cloud.laravel.com/docs/compute#inertia-ssr) を使用できます。

### Laravel Forge

Forge で SSR サーバーを実行するには、アプリのルートディレクトリから `php artisan inertia:start-ssr` を実行する新しいデーモンを作成してください。または、Forge アプリケーションの管理ダッシュボードにある組み込みの Inertia 連携を利用することもできます。

以降、アプリケーションをデプロイするたびに `php artisan inertia:stop-ssr` コマンドを呼び出すことで、SSR サーバーを自動的に再起動できます。これにより、既存の SSR サーバーが停止され、プロセスモニターによって新しいサーバーが起動されます。

### Heroku

Heroku で SSR サーバーを実行するには、`Procfile` の `web` 設定を更新し、ウェブサーバーを起動する前に SSR サーバーを実行するようにします。

```bash
web: php artisan inertia:start-ssr & vendor/bin/heroku-php-apache2 public/
```

なお、SSR サーバーを実行するには、`heroku/php` ビルドパックに加えて `heroku/nodejs` ビルドパックがインストールされている必要があります。
