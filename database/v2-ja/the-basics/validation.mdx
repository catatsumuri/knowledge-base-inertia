---
title: バリデーション
---

## 仕組み

Inertia におけるサーバーサイドのバリデーションエラーの扱いは、`422` レスポンスを受け取ってバリデーションエラーを捕捉し、手動でフォームのエラー状態を更新する必要がある従来の XHR 駆動フォームとは異なります。というのも、Inertia は `422` レスポンスを受信しないからです。その代わり、Inertia は標準的なフルページのフォーム送信に非常に近い形で動作します。以下がその流れです。

まず、[Inertia を使ってフォームを送信](/v2/the-basics/forms) します。サーバーサイドでバリデーションエラーが発生した場合、それらのエラーを `422` の JSON レスポンスとして返すのではありません。代わりに、サーバー側でユーザーを直前にいたフォームページへリダイレクトし、バリデーションエラーをセッションにフラッシュします。Laravel などの一部のフレームワークでは、これは自動的に行われます。

次に、これらのバリデーションエラーがセッションに存在する場合、それらは自動的に Inertia と共有され、ページの props としてクライアントサイドから利用可能になります。props はリアクティブであるため、フォーム送信が完了した時点で自動的に表示されます。

最後に、Inertia アプリは `422` レスポンスを生成しないため、レスポンスにバリデーションエラーが含まれているかどうかを判断する別の方法が必要です。これを実現するために、Inertia は `page.props.errors` オブジェクトにエラーが存在するかどうかをチェックします。エラーが存在する場合、`onSuccess()` コールバックの代わりに、リクエストの `onError()` コールバックが呼び出されます。

## エラーの共有

サーバーサイドのバリデーションエラーをクライアントサイドで利用できるようにするには、サーバーサイドのフレームワークがそれらを `errors` prop として共有する必要があります。Laravel アダプターなどの Inertia のファーストパーティ製アダプターは、これを自動的に行います。他のフレームワークの場合は、手動で設定する必要があるかもしれません。詳細については、使用しているサーバーサイドアダプターのドキュメントを参照してください。

## エラーの表示

バリデーションエラーはページコンポーネントの props としてクライアントサイドで利用可能になるため、その存在に基づいて条件付きで表示できます。ファーストパーティのサーバーアダプター（Laravel アダプターなど）を使用している場合、`errors` prop は自動的にページで利用可能になる点に注意してください。

<CodeGroup>

```vue Vue icon="vuejs"
<script setup>
import { reactive } from 'vue'
import { router } from '@inertiajs/vue3'

defineProps({ errors: Object })

const form = reactive({
    first_name: null,
    last_name: null,
    email: null,
})

function submit() {
    router.post('/users', form)
}
</script>

<template>
    <form @submit.prevent="submit">
        <label for="first_name">First name:</label>
        <input id="first_name" v-model="form.first_name" />
        <div v-if="errors.first_name">{{ errors.first_name }}</div>
        <label for="last_name">Last name:</label>
        <input id="last_name" v-model="form.last_name" />
        <div v-if="errors.last_name">{{ errors.last_name }}</div>
        <label for="email">Email:</label>
        <input id="email" v-model="form.email" />
        <div v-if="errors.email">{{ errors.email }}</div>
        <button type="submit">Submit</button>
    </form>
</template>
```

```jsx React icon="react"
import { useState } from 'react'
import { router, usePage } from '@inertiajs/react'

export default function Edit() {
    const { errors } = usePage().props

    const [values, setValues] = useState({
        first_name: null,
        last_name: null,
        email: null,
    })

    function handleChange(e) {
        setValues(values => ({
            ...values,
            [e.target.id]: e.target.value,
        }))
    }

    function handleSubmit(e) {
        e.preventDefault()
        router.post('/users', values)
    }

    return (
        <form onSubmit={handleSubmit}>
            <label htmlFor="first_name">First name:</label>
            <input id="first_name" value={values.first_name} onChange={handleChange} />
            {errors.first_name && <div>{errors.first_name}</div>}
            <label htmlFor="last_name">Last name:</label>
            <input id="last_name" value={values.last_name} onChange={handleChange} />
            {errors.last_name && <div>{errors.last_name}</div>}
            <label htmlFor="email">Email:</label>
            <input id="email" value={values.email} onChange={handleChange} />
            {errors.email && <div>{errors.email}</div>}
            <button type="submit">Submit</button>
        </form>
    )
}
```

```svelte Svelte icon="s"
<script>
    import { router } from '@inertiajs/svelte'

    export let errors = {}

    let values = {
        first_name: null,
        last_name: null,
        email: null,
    }

    function handleSubmit() {
        router.post('/users', values)
    }
</script>

<form on:submit|preventDefault={handleSubmit}>
    <label for="first_name">First name:</label>
    <input id="first_name" bind:value={values.first_name}>
    {#if errors.first_name}<div>{errors.first_name}</div>{/if}

    <label for="last_name">Last name:</label>
    <input id="last_name" bind:value={values.last_name}>
    {#if errors.last_name}<div>{errors.last_name}</div>{/if}

    <label for="email">Email:</label>
    <input id="email" bind:value={values.email}>
    {#if errors.email}<div>{errors.email}</div>{/if}

    <button type="submit">Submit</button>
</form>
```

</CodeGroup>

Vue アダプターを使用している場合は、`$page.props.errors` オブジェクト経由でもエラーにアクセスできます。

### フィールドごとの複数エラー

デフォルトでは、Inertia の Laravel アダプターは各フィールドにつき最初のバリデーションエラーのみを返します。すべてのエラーを受け取りたい場合は、ミドルウェアで `$withAllErrors` プロパティを `true` に設定することで有効化できます。

```php
class HandleInertiaRequests extends Middleware
{
    protected $withAllErrors = true;

    // ...
}
```

有効にすると、各フィールドには単一の文字列ではなく、エラー文字列の配列が含まれるようになります。

<CodeGroup>

```vue Vue icon="vuejs"
<p v-for="error in errors.email">{{ error }}</p>
```

```jsx React icon="react"
{errors.email.map((error, index) => <p key={index}>{error}</p>)}
```

```svelte Svelte icon="s"
{#each errors.email as error}
    <p>{error}</p>
{/each}
```

</CodeGroup>

文字列ではなく配列を想定するように、[TypeScript を設定](/v2/advanced/typescript#error-values) することもできます。

## 入力値の再設定

Inertia におけるエラー処理はフルページのフォーム送信と似ていますが、Inertia にはさらに多くの利点があります。実際、古いフォーム入力データを手動で再設定する必要すらありません。

バリデーションエラーが発生すると、ユーザーは通常、直前にいたフォームページへリダイレクトされます。そしてデフォルトでは、Inertia は `post`、`put`、`patch`、`delete` リクエストに対して [コンポーネントの状態](/v2/the-basics/manual-visits#state-preservation) を自動的に保持します。そのため、ユーザーがフォームを送信した時点の入力データは、そのまま正確に保持されます。

つまり、残る作業は `errors` prop を使ってバリデーションエラーを表示することだけです。

## エラーバッグ

[フォームヘルパー](/v2/the-basics/forms#form-helper) を使用している場合、バリデーションエラーはリクエストを行ったフォームオブジェクトに自動的にスコープされるため、エラーバッグを使用する必要はありません。

1 つのページに複数のフォームがある場合、2 つのフォームが同じフィールド名を共有していると、バリデーションエラーの表示時に競合が発生する可能性があります。たとえば、「会社を作成する」フォームと「ユーザーを作成する」フォームの両方に `name` フィールドがあるとします。両方のフォームが `page.props.errors.name` のバリデーションエラーを表示するため、どちらか一方のフォームで `name` フィールドのバリデーションエラーが発生すると、両方のフォームにエラーが表示されてしまいます。

この問題を解決するために、「エラーバッグ」を使用できます。エラーバッグは、サーバーから返されるバリデーションエラーを、そのフォーム固有の一意なキーの下にスコープします。先ほどの例を続けると、最初のフォームには `createCompany` エラーバッグを、2 つ目のフォームには `createUser` エラーバッグを使用できます。

<CodeGroup>

```js Vue icon="vuejs"
import { router } from '@inertiajs/vue3'

router.post('/companies', data, {
    errorBag: 'createCompany',
})

router.post('/users', data, {
    errorBag: 'createUser',
})
```

```js React icon="react"
import { router } from '@inertiajs/react'

router.post('/companies', data, {
    errorBag: 'createCompany',
})

router.post('/users', data, {
    errorBag: 'createUser',
})
```

```js Svelte icon="s"
import { router } from '@inertiajs/svelte'

router.post('/companies', data, {
    errorBag: 'createCompany',
})

router.post('/users', data, {
    errorBag: 'createUser',
})
```

</CodeGroup>

エラーバッグを指定すると、バリデーションエラーは `page.props.errors.createCompany` および `page.props.errors.createUser` 内に含まれてサーバーから返されます。
